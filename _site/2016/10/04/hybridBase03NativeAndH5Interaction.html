<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Hybrid APP基础篇(三)->Hybrid APP之Native和H5页面交互原理 | Dailc的个人主页</title>
    <meta name="author" content="dailc" />
    <meta name="renderer" content="webkit">
    <meta name="description" content="Everything about dailc" />
    <meta name="baidu-site-verification" content="cVrw8PsZv7" />
    <meta name="keywords" content="dailc,戴荔春,戴荔春的博客,dailc的博客" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  	<link href="/asserts/css/default.css" rel="stylesheet" type="text/css" media="all">
	<script type="text/javascript" src="/asserts/js/app.js" ></script> 
</head>
<body>
	<!--头部 -->
	<header class="header">
		<div class="header-container">
			<section class="site-logo">
				<a  href="/">撒网要见鱼</a>
			</section>
			<button class="collapsed " type="button" >
		        <span class="icon-bar"></span>
		        <span class="icon-bar"></span>
		        <span class="icon-bar"></span>
		    </button>
		    <div class="menu-container">
				<nav class="site-nav">
					<ul>
						<li>
							<a  href="/blog/archiveAll.html">随笔</a>
						</li>
						<li>
							<a  href="/blog/archive.html">博客</a>
						</li>
						<li>
							<a  href="/blog/categories.html">分类</a>
						</li>
						<li>
							<a  href="/blog/tags.html">标签</a>
						</li>
						<li>
							<a  href="/demo/demo.html">Demo</a>
						</li>
						<li>
							<a  href="/favour/music.html">音乐</a>
						</li>
						<li>
							<a  href="/favour/book.html">Book</a>
						</li>
						<li>
							<a  href="/about/timeline.html">时间轴</a>
						</li>
						<li>
							<a  href="/others/collection.html">收藏</a>
						</li>
						<li>
							<a  href="/about/about.html">关于</a>
						</li>
					</ul>
				</nav>
				<div class="site-search">
					<input type="text" />
				</div>
			</div>
		</div>
	</header>
	<link href="/asserts/css/blog_article_post.css" rel="stylesheet" type="text/css" media="all">
<link href="/asserts/css/blog_personCard_style.css" rel="stylesheet" type="text/css" media="all">
<link href="/asserts/css/imageBubble.css" rel="stylesheet" type="text/css" media="all">
	
	<div class="wrap">
		<div class="container">
			<!-- 左侧，内容，多说评论等-->
			<div class="col-md-9">
				<!-- 内容-->
				<div class="markdown-body">
					<!--标题区域 -->
					<div class="title-container">
					<h1 class="page-title"><a  title="Hybrid APP基础篇(三)->Hybrid APP之Native和H5页面交互原理">Hybrid APP基础篇(三)->Hybrid APP之Native和H5页面交互原理</a> </h1>
						<!-- metainfo-->
						<section class="meta clearfix">
<span class="time">
<time datetime="2016-10-04">2016-10-04</time>
</span>

| 
<span class="categories">
	分类
	    
	    <a href="/blog/categories.html#blog" title="blog">blog</a>&nbsp;
	    
</span>


| 
<span class="tags">
	标签
		
		<a href="/blog/tags.html#Hybrid" title="Hybrid">Hybrid</a>&nbsp;
		
</span>

| 
<span class="views">
	浏览
	<a id="busuanzi_value_page_pv"></a>&nbsp;
</span>
</section>
						<section class="right-tips">
							<span >
								Hybrid
							</span>
						</section>
					</div>
					<!-- 特别推荐-->
					
					<!-- 内容区域-->
					<div class="content-container">
						 <h2 id="前言">前言</h2>

<h3 id="写在前面的话">写在前面的话</h3>

<p><strong>20170219更新</strong>
将稿子重新整理成MD形式了</p>

<p><strong>20161004更新</strong>
初稿发布</p>

<h3 id="前置文章">前置文章</h3>
<p>阅读本文之前，建议先阅读下列前置文章</p>

<ul>
  <li><a href="https://dailc.github.io/2016/10/04/hybridBase01HybridInfo.html">Hybrid APP基础篇(一)-&gt;什么是Hybrid App</a></li>
</ul>

<h3 id="楔子">楔子</h3>
<p>Hybrid APP的关键是原生页面与H5页面直接的交互,本文做简单介绍</p>

<h2 id="androidios原生和h5的基本通信机制">Android、iOS原生和H5的基本通信机制</h2>
<p>在Hybrid APP中,原生与H5的交互方式在Android和iOS上的实现是有异同的,原因是Android、iOS的通信机制有所区别,下面介绍原生和H5相互调用的方法</p>

<h3 id="android端">Android端</h3>

<h4 id="native调js">Native调JS</h4>
<p>4.4版本之前</p>

<div class="highlighter-rouge"><pre class="highlight"><code>// mWebView = new WebView(this); //即当前webview对象			
mWebView.loadUrl("javascript: 方法名('参数,需要转为字符串')"); 

//ui线程中运行
 runOnUiThread(new Runnable() {  
        @Override  
        public void run() {  
            mWebView.loadUrl("javascript: 方法名('参数,需要转为字符串')");  
            Toast.makeText(Activity名.this, "调用方法...", Toast.LENGTH_SHORT).show();  
        }  
});  
</code></pre>
</div>

<p>4.4以后(包括4.4)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//异步执行JS代码,并获取返回值	
mWebView.evaluateJavascript("javascript: 方法名('参数,需要转为字符串')", new ValueCallback&lt;String&gt;() {
        @Override
        public void onReceiveValue(String value) {
    		//这里的value即为对应JS方法的返回值
        }
});
</code></pre>
</div>

<p>如上所示,Native用H5页面中的JS方法,有如下特点</p>

<ul>
  <li>4.4之前Native通过loadUrl来调用JS方法,只能让某个JS方法执行,但是无法获取该方法的返回值</li>
  <li>4.4之后,通过evaluateJavascript异步调用JS方法,并且能在onReceiveValue中拿到返回值</li>
  <li>不适合传输大量数据(大量数据建议用接口方式获取)</li>
  <li>mWebView.loadUrl(“javascript: 方法名(‘参数,需要转为字符串’)”);函数需在UI线程运行，因为mWebView为UI控件(但是有一个坏处是会阻塞UI线程)</li>
</ul>

<h4 id="js调native">JS调Native</h4>

<div class="highlighter-rouge"><pre class="highlight"><code> WebSettings webSettings = mWebView.getSettings();  
 //Android容器允许JS脚本，必须要
webSettings.setJavaScriptEnabled(true);
//Android容器设置侨连对象
mWebView.addJavascriptInterface(getJSBridge(), "JSBridge");
</code></pre>
</div>

<p>Android中JSBridge的代码</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//Android4.2版本以上，本地方法要加上注解@JavascriptInterface，否则会找不到方法。
private Object getJSBridge(){  
    Object insertObj = new Object(){  
    	@JavascriptInterface
        public String foo(){  
            return "foo";  
        }  
        
        @JavascriptInterface
        public String foo2(final String param){  
            return "foo2:" + param;  
        }  
          
    };  
    return insertObj;  
}  
</code></pre>
</div>

<p>Html中JS调用原生的代码</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//调用方法一
window.JSBridge.foo(); //返回:'foo'
//调用方法二
window.JSBridge.foo2('test');//返回:'foo2:test'
</code></pre>
</div>

<p>如上所示,Native中通过addJavascriptInterface添加暴露出来的JS桥对象,然后再该对象内部声明对应的API方法,有如下特点:</p>

<ul>
  <li>在Android4.2以上(api17后),暴露的api要加上注解@JavascriptInterface，否则会找不到方法。</li>
  <li>在api17以前,addJavascriptInterface有风险,hacker可以通过反编译获取Native注册的Js对象，然后在页面通过反射Java的内置静态类，获取一些敏感的信息和破坏
    <ul>
      <li>所以,也就是为什么Android中也会使用JSBridge来进行交互,而不是addJavascriptInterface直接暴露api</li>
    </ul>
  </li>
  <li>JS能调用到已经暴露的api,并且能得到相应返回值</li>
</ul>

<h3 id="ios端">iOS端</h3>

<h4 id="native调js-1">Native调JS</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>//可以取得JS函数执行的返回值
//方法必须是Html页面绑定在最顶层的window上对象的
//如window.top.foo
//Swift
webview.stringByEvaluatingJavaScriptFromString("方法名(参数)")
//OC
[webView stringByEvaluatingJavaScriptFromString:@"方法名(参数);"];
</code></pre>
</div>

<p>如上所示,Native通过stringByEvaluatingJavaScriptFromString调用Html绑定在window上的函数,有如下特点</p>

<ul>
  <li>Native调用JS方法时,能拿到JS方法的返回值</li>
  <li>不适合传输大量数据(大量数据建议用接口方式获取)</li>
</ul>

<h4 id="js调native-1">JS调Native</h4>
<p>引入官方的库文件</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#import &lt;JavaScriptCore/JavaScriptCore.h&gt;	
</code></pre>
</div>

<p>Native注册api函数(OC)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//webview加载完毕后设置一些js接口
-(void)webViewDidFinishLoad:(UIWebView *)webView{
    [self hideProgress];
    [self setJSInterface];
}

-(void)setJSInterface{
    
    JSContext *context =[_wv valueForKeyPath:@"documentView.webView.mainFrame.javaScriptContext"];
    
    // 注册名为foo的api方法
    context[@"foo"] = ^() {
    	
    	//获取参数
        NSArray *args = [JSContext currentArguments];
        NSString *title = [NSString stringWithFormat:@"%@",[args objectAtIndex:0]];
        //做一些自己的逻辑
        //返回一个值  'foo:'+title
        return [NSString stringWithFormat:@"foo:%@", title];
    };
     
}	
</code></pre>
</div>

<p>Html中JS调用原生的代码</p>

<p><code class="highlighter-rouge">
//调用方法,用top是确保调用到最顶级,因为iframe要用top才能拿到顶级
window.top.foo('test'); //返回:'foo:test'
</code></p>

<p>如上所示,Native中通过引入官方提供的JavaScriptCore库(iOS7中出现的),然后可以将api绑定到JSContext上(然后Html中JS默认通过window.top.***可调用)。有如下特点</p>

<ul>
  <li>iOS7才出现这种方式,在这之前,js无法直接调用Native,只能通过JSBridge方式简介调用</li>
  <li>JS能调用到已经暴露的api,并且能得到相应返回值</li>
  <li>iOS原生本身是无法被JS调用的,但是通过引入官方提供的第三方”JavaScriptCore”,即可开放api给JS调用</li>
</ul>

<h2 id="原生和h5的另一种通讯方式jsbridge">原生和H5的另一种通讯方式:JSBridge</h2>
<p>实际上,Native与H5通信,除了前面提到的用基本方法外,还有一种广为流行的方法:JSBridge</p>

<h3 id="什么是jsbridge">什么是JSBridge</h3>
<p>JSBridge是广为流行的Hybrid开发中JS和Native一种通信方式,各大公司的应用中都有用到这种方法</p>

<p>简单的说,JSBridge就是定义Native和JS的通信,Native只通过一个固定的桥对象调用JS,JS也只通过固定的桥对象调用Native,基本原理是:</p>

<p>H5-&gt;通过某种方式触发一个url-&gt;Native捕获到url,进行分析-&gt;原生做处理-&gt;Native调用H5的JSBridge对象传递回调。如下图</p>

<p><img src="https://dailc.github.io/staticResource/blog/hybrid/jsbridge/img_hybrid_base_jsbridgePrinciple_1.png" alt="" /></p>

<p>上图简单的介绍了下JSBridge的核心原理,具体详细实现请参考后面详解。</p>

<h3 id="为什么要用jsbridge">为什么要用JSBridge</h3>
<p>在上文中我们有提到Native和原生之间的基本通信,既然Native和原生已经能够实现通信了,那为什么还要这种通过url scheme的JSBridge方式呢,原因大致如下</p>

<ul>
  <li>Android4.2以下,addJavascriptInterface方式有安全漏掉</li>
  <li>iOS7以下,JS无法调用Native</li>
  <li>url scheme交互方式是一套现有的成熟方案,可以完美兼容各种版本,不存在上述问题</li>
</ul>

<p>另外,请注意,可以理解为JSBridge是一种交互理念,而上述的url scheme则是其中的一种实现,所以也就是说,就算后面实现变为了addJavascriptInterface,JavaScriptCore,也一样是JSBridge交互</p>

<p>JSBridge交互的一个很大特点就是便于拓展,而且没有重大的安全性问题,所以也就是为什么它广为流行</p>

<h3 id="jsbridge原理以及实现">JSBridge原理以及实现</h3>
<p>JSBridge的原理和实现请参考 <a href="https://dailc.github.io/2016/10/04/hybridBase04JSbridgePrinciple.html">Hybrid APP基础篇(四)-&gt;JSBridge实现原理</a></p>

<h2 id="附录">附录</h2>

<h2 id="原文地址">原文地址</h2>
<p>原文在我个人博客上面
<a href="https://dailc.github.io/2016/10/04/hybridBase03NativeAndH5Interaction.html">Hybrid APP基础篇(三)-&gt;Hybrid APP之Native和H5页面交互原理</a></p>

<h3 id="参考来源">参考来源</h3>

<ul>
  <li><a href="http://www.jianshu.com/p/9fd80b785de1">JSBridge-Web与Native交互之iOS篇</a></li>
  <li><a href="http://blog.csdn.net/jacin1/article/details/39993935">Ios Android Hybrid app 与 Js Bridge</a></li>
  <li><a href="http://www.tuicool.com/articles/yeeABzJ">Hybrid APP架构设计思路</a></li>
  <li><a href="http://blog.csdn.net/zhouyongyang621/article/details/47000041">Android4.2下 WebView的addJavascriptInterface漏洞解决方案</a></li>
  <li><a href="http://blog.csdn.net/it1039871366/article/details/46372207">WebView—Android与js交互实例</a></li>
</ul>

					</div>
					<!-- 上一篇与下一篇-->
					<section align="right" class="post-next-prev">
					  <span>
					    <a  href="/2016/10/04/hybridBase02HybridCompareOthers.html" class="active"  >上一篇</a>
					    &nbsp;&nbsp;&nbsp;
					    <a  href="/2016/10/04/hybridBase04JSbridgePrinciple.html" class="active"  >下一篇</a>
					  </span>
					</section>
				</div>
				<!-- 多说-->
				
<!--多说评论 -->
<div id="duoshuo-container">
<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="http://localhost:4000/2016/10/04/hybridBase03NativeAndH5Interaction.html}" data-title="Hybrid APP基础篇(三)->Hybrid APP之Native和H5页面交互原理" data-url="http://localhost:4000/2016/10/04/hybridBase03NativeAndH5Interaction.html"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"dailc"};
(function() {
	var ds = document.createElement('script');
	ds.type = 'text/javascript';ds.async = true;
	ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
	ds.charset = 'UTF-8';
	(document.getElementsByTagName('head')[0] 
	 || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script>
<!-- 多说公共JS代码 end -->
</div>

				
				
			</div>
			
			<!-- 右侧包括个人介绍，TOC菜单-->
			<div class="col-md-3">
				<!-- 右侧人物面板-->
				<div class="effect1 person-card">
					
				 	<a  class="member-image">
				 			<img src="/asserts/images/img_avatar.jpg" alt="Lichun Dai"/>
				 	</a>
				 	<div class="member-info">
				 		<p class="info-name">
				 		<a >
				 			Lichun Dai
				 		</a>
				 		</p>
				 		<p>
				 			单线程生物，无法同时专注于多件事情。做自己感兴趣的工作，目前偏爱前端。业余爱好:口琴、吉他。
				 		</p>
				 	<p class="info-foot">
				 		<a class="left-card left" href="/blog/archive.html">
				 			<em>
				 				博客
				 			</em>
				 			<strong>
				 				28
				 				
				 			</strong>
				 		</a>
				 		<a class="middle-card left" href="/demo/demo.html">
				 			<em>
				 				项目
				 			</em>
				 			<strong>
				 				2
				 			</strong>
				 		</a>
				 		<a class="right-card left" href="/blog/archiveAll.html">
				 			<em>
				 				随笔
				 			</em>
				 			<strong>
				 				58
				 			</strong>
				 		</a>
				 	</p>
				 	<p class="info-social-touch">
				 		<a target="_blank" href="https://github.com/dailc" ><img src="/asserts/images/icons/favicon_github.ico" alt="GitHub"/> </a>
						<a target="_blank" href="http://5sing.kugou.com/54188866/default.html"><img src="/asserts/images/icons/favicon_5sing.ico" alt="5sing" /> </a>	
						<a target="_blank" href="http://changba.com/u/200945262"><img src="/asserts/images/icons/favicon_changba.ico" alt="唱吧" /> </a>
						<a target="_blank" href="https://www.zhihu.com/people/dailichun"><img src="/asserts/images/icons/favicon_zhihu.ico" alt="知乎" /> </a>
						<a target="_blank" href="http://www.jianshu.com/u/c104d2a4baec"><img src="/asserts/images/icons/favicon_jianshu.ico" alt="简书" /> </a>
				 	</p>
				 	</div>
				</div>

				 <!-- TOC动态菜单-->
				  <div class="slideNavContainer">     
				</div> 				
					
			</div> 
 
		</div>
	</div>
		
<script type="text/javascript" src="/asserts/js/post.js" ></script>
<script type="text/javascript" src="/asserts/js/imageBubble.js" ></script>
<script>
	ImageBubble.init('.container img');
</script>
	
	<!-- 脚步,包括版权声明，访问次数等-->
	<footer class="footer">
	    <p class="copyright">
	    	<small>
	            <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/cn/" target="_blank" title="许可协议">©</a> 2016&nbsp;&nbsp;&nbsp;&nbsp;<a href="/about/">Lichun Dai</a>
	        </small>
	    </p>
	    <p class="more-tips">
	    	<span>Powered by Jekyll</span>&nbsp;&nbsp;&nbsp;&nbsp;
	    	<span id="busuanzi_container_site_pv">总访客<span id="busuanzi_value_site_uv" class="site-uv"></span>人</span>&nbsp;&nbsp;&nbsp;&nbsp;
	    	<span id="busuanzi_container_site_pv">总访问<span id="busuanzi_value_site_pv" class="site-pv"></span>次</span>
	    </p>  
	</footer>

<script>
//百度统计
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?cf8506e0ef223e57ff6239944e5d46a4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<!--不蒜子 -->
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



</body>
</html>
